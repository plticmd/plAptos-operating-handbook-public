"use strict";(self.webpackChunkaptos_docs=self.webpackChunkaptos_docs||[]).push([[94],{55993:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>c});var s=t(63159),a=t(83581);t(3688);const i={title:"Gas Profiling"},o="Gas Profiling",r={id:"move/move-on-aptos/gas-profiling",title:"Gas Profiling",description:"The Aptos Gas Profiler is a powerful tool that can help you understand the gas usage of Aptos transactions.",source:"@site/i18n/ja/docusaurus-plugin-content-docs/current/move/move-on-aptos/gas-profiling.md",sourceDirName:"move/move-on-aptos",slug:"/move/move-on-aptos/gas-profiling",permalink:"/move/move-on-aptos/gas-profiling",draft:!1,unlisted:!1,editUrl:"https://github.com/aptos-labs/developer-docs/edit/main/apps/docusaurus/docs/move/move-on-aptos/gas-profiling.md",tags:[],version:"current",lastUpdatedAt:1713535793,formattedLastUpdatedAt:"2024\u5e744\u670819\u65e5",frontMatter:{title:"Gas Profiling"},sidebar:"appSidebar",previous:{title:"Cryptography",permalink:"/move/move-on-aptos/cryptography"},next:{title:"Security",permalink:"/move/move-on-aptos/move-security-guidelines"}},l={},c=[{value:"Using the Gas Profiler",id:"using-the-gas-profiler",level:2},{value:"Understanding the Gas Report",id:"understanding-the-gas-report",level:2},{value:"Flamegraphs",id:"flamegraphs",level:3},{value:"Cost Break-down",id:"cost-break-down",level:3},{value:"Full Execution Trace",id:"full-execution-trace",level:3},{value:"Future Plans",id:"future-plans",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"gas-profiling",children:"Gas Profiling"}),"\n",(0,s.jsxs)(n.p,{children:["The Aptos Gas Profiler is a powerful tool that can help you understand the gas usage of Aptos transactions.\nOnce activated, it will simulate transactions using an instrumented VM, and generate a web-based report. ",(0,s.jsx)("a",{href:"/gas-profiling/sample-report/index.html",target:"_blank",children:"[Sample]"})]}),"\n",(0,s.jsx)(n.p,{children:"The gas profiler can also double as a debugger since the report also includes a full execution trace."}),"\n",(0,s.jsx)(n.h2,{id:"using-the-gas-profiler",children:"Using the Gas Profiler"}),"\n",(0,s.jsxs)(n.p,{children:["The gas profiler can be invoked by appending the ",(0,s.jsx)(n.code,{children:"--profile-gas"})," option to Aptos CLI\u2019s ",(0,s.jsx)(n.code,{children:"move publish"}),", ",(0,s.jsx)(n.code,{children:"move run"})," or ",(0,s.jsx)(n.code,{children:"move run-script"})," commands."]}),"\n",(0,s.jsxs)(n.p,{children:["Here is an example using the ",(0,s.jsx)(n.a,{href:"https://github.com/aptos-labs/aptos-core/tree/main/aptos-move/move-examples/hello_blockchain",children:"hello_blockchain package from move examples"}),". First, ",(0,s.jsx)(n.code,{children:"cd"})," into the package directory."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ cd aptos-move/move-examples/hello_blockchain\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then, we can simulate module publishing with the extra option ",(0,s.jsx)(n.code,{children:"--profile-gas"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Notice that you do need to have your CLI profile set up properly and bind the named addresses correctly. Please refer to ",(0,s.jsx)(n.a,{href:"../../../tools/aptos-cli/use-cli/cli-configuration#initialize-local-configuration-and-create-an-account",children:"CLI Configuration"})," for more details."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ aptos move publish --named-addresses hello_blockchain=default --profile-gas\n"})}),"\n",(0,s.jsx)(n.p,{children:"This will result in some terminal output that looks like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",metastring:'title="Output"',children:'Compiling, may take a little while to download git dependencies...\nINCLUDING DEPENDENCY AptosFramework\nINCLUDING DEPENDENCY AptosStdlib\nINCLUDING DEPENDENCY MoveStdlib\nBUILDING Examples\npackage size 1755 bytes\n\nSimulating transaction locally with the gas profiler...\n{\n  "Result": \n    "transaction_hash": "0x26cc23d11070e6756c6b2ae0ea7d3fc4c791b59cf821f268ba0f03eebb487543",\n    "gas_used": 1039,\n    "gas_unit_price": 100,\n    "sender": "dbcbe741d003a7369d87ec8717afb5df425977106497052f96f4e236372f7dd5",\n    "success": true,\n    "version": 762354147,\n    "vm_status": "status EXECUTED of type Execution"\n  }\n\n'})}),"\n",(0,s.jsx)(n.p,{children:"Again, it should be emphasized that even though the live chain-state is being used, this is a simulation so the module has NOT really been published to the target network."}),"\n",(0,s.jsxs)(n.p,{children:["You can then find the generated gas report in the directory ",(0,s.jsx)(n.code,{children:"gas-profiling"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",metastring:'title="Directory Layout"',children:"- hello_blockchain\n  - gas-profiling\n    - txn-xxxxxxxx-0x1-code-publish_package_txn\n      - assets\n      - index.html\n  - sources\n  - Move.toml\n"})}),"\n",(0,s.jsx)(n.p,{children:"index.html is the main page of the report, and you can view it in your web browser."}),"\n",(0,s.jsx)(n.h2,{id:"understanding-the-gas-report",children:"Understanding the Gas Report"}),"\n",(0,s.jsx)(n.p,{children:"The gas report consists of three parts, enabling you to understand the gas usage through different lenses."}),"\n",(0,s.jsx)(n.h3,{id:"flamegraphs",children:"Flamegraphs"}),"\n",(0,s.jsx)(n.p,{children:"The first section consists of visualization of the gas usage in the form of two flamegraphs: one for execution & IO, the other for storage.\nThe reason why we need two graphs is that these are measured in different units: one in gas units, and the other in APT."}),"\n",(0,s.jsx)(n.p,{children:"It is possible to interact with various elements in the graph. If you hover your cursor over an item, it will show you the precise cost and percentage."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"gas-profiling-flamegraph-0.png",src:t(81751).A+"",width:"1645",height:"263"})}),"\n",(0,s.jsx)(n.p,{children:'If you click on an item, you can zoom into it and see the child items more clearly.\nYou can reset the view by clicking the "Reset Zoom" button in the top-left corner.'}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"gas-profiling-flamegraph-1.png",src:t(8110).A+"",width:"1887",height:"260"})}),"\n",(0,s.jsx)(n.p,{children:"There is also \u201cSearch\u201d button in the top-right corner that allows to match certain items and highlight them."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"gas-profiling-flamegraph-2.png",src:t(10533).A+"",width:"1638",height:"261"})}),"\n",(0,s.jsx)(n.h3,{id:"cost-break-down",children:"Cost Break-down"}),"\n",(0,s.jsx)(n.p,{children:"The second section is a detailed break-down of all gas costs. Data presented in this section is categorized, aggregated and sorted.\nThis can be especially helpful if you know what numbers to look at."}),"\n",(0,s.jsx)(n.p,{children:"For example, the following tables show the IO costs of all storage operations.\nThe percentage here is relative to the total cost of the belonging category (Exec + IO in this case)."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"gas-profiling-cost-break-down-table.png",src:t(32858).A+"",width:"1303",height:"380"})}),"\n",(0,s.jsx)(n.h3,{id:"full-execution-trace",children:"Full Execution Trace"}),"\n",(0,s.jsx)(n.p,{children:"The final section of the gas report is the full execution trace of the transaction that looks like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"execution & IO (gas unit, full trace)                        106.45206    100.00%\n    intrinsic                                                3.94         3.70%\n    0x1::code::publish_package_txn                           100.02706    93.96%\n        move_loc                                             0.0024       0.00%\n        move_loc                                             0.0024       0.00%\n        call_generic                                         0.024        0.02%\n        0x1::util::from_bytes<0x1::code::PackageMetadata>    0.1094       0.10%\n        move_loc                                             0.0024       0.00%\n        call                                                 0.064        0.06%\n        0x1::code::publish_package                           99.82126     93.77%\n            call                                             0.02         0.02%\n            0x1::code::upgrade_policy_arbitrary              0.0076       0.01%\n                ld_u8                                        0.0012       0.00%\n                pack                                         0.0052       0.00%\n                ret                                          0.0012       0.00%\n            st_loc                                           0.0024       0.00%\n            imm_borrow_loc                                   0.0012       0.00%\n            imm_borrow_field                                 0.004        0.00%\n            imm_borrow_field                                 0.004        0.00%\n            read_ref                                         0.0072       0.01%\n            imm_borrow_loc                                   0.0012       0.00%\n            imm_borrow_field                                 0.004        0.00%\n            read_ref                                         0.0072       0.01%\n            gt                                               0.0032       0.00%\n            br_false                                         0.0024       0.00%\n            branch                                           0.0016       0.00%\n            @17\n...\n"})}),"\n",(0,s.jsx)(n.p,{children:"The left column lists all Move instructions and operations being executed, with each level of indentation indicating a function call."}),"\n",(0,s.jsx)(n.p,{children:"The middle column represents the gas costs associated with the operations."}),"\n",(0,s.jsxs)(n.p,{children:["There is also a special notation ",(0,s.jsx)(n.code,{children:"@number"})," that represents a jump to a particular location in the byte code.\nThis is purely informational and to help understand the control flow."]}),"\n",(0,s.jsx)(n.h2,{id:"future-plans",children:"Future Plans"}),"\n",(0,s.jsx)(n.p,{children:"We plan to extend the gas profiler with the following features:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Ability to replay historical transactions that have been committed (on mainnet, testnet etc.)."}),"\n",(0,s.jsx)(n.li,{children:"Ability to annotate source files."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Feedbacks and feature requests are welcome! Please kindly submit them by creating GitHub issues ",(0,s.jsx)(n.a,{href:"https://github.com/aptos-labs/aptos-core/issues",children:"here"}),"."]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},32858:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/gas-profiling-cost-break-down-table-3ad02672aec67880bd138381d6eb5c22.png"},81751:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/gas-profiling-flamegraph-0-7fd866797c300df743450367cdb363a9.png"},8110:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/gas-profiling-flamegraph-1-89ebcd6fc93b219535f28b3022e2fd3b.png"},10533:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/gas-profiling-flamegraph-2-9ba9285aee7f551bbaffb46a9e27b905.png"}}]);