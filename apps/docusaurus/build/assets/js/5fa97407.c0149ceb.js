"use strict";(self.webpackChunkaptos_docs=self.webpackChunkaptos_docs||[]).push([[3726],{75190:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>t,metadata:()=>d,toc:()=>l});var i=o(63159),s=o(83581);const t={title:"Using Source Code",slug:"run-validator-node-using-source"},r="Using Source Code",d={id:"nodes/validator-node/operator/running-validator-node/using-source-code",title:"Using Source Code",description:"This is a step-by-step guide to deploy an Aptos validator and validator fullnode (VFN) using source code. Using this guide, the validator",source:"@site/i18n/ja/docusaurus-plugin-content-docs/current/nodes/validator-node/operator/running-validator-node/using-source-code.md",sourceDirName:"nodes/validator-node/operator/running-validator-node",slug:"/nodes/validator-node/operator/running-validator-node/run-validator-node-using-source",permalink:"/nodes/validator-node/operator/running-validator-node/run-validator-node-using-source",draft:!1,unlisted:!1,editUrl:"https://github.com/aptos-labs/developer-docs/edit/main/apps/docusaurus/docs/nodes/validator-node/operator/running-validator-node/using-source-code.md",tags:[],version:"current",lastUpdatedAt:1713276994,formattedLastUpdatedAt:"2024\u5e744\u670816\u65e5",frontMatter:{title:"Using Source Code",slug:"run-validator-node-using-source"},sidebar:"nodeSidebar",previous:{title:"Deploy Nodes",permalink:"/nodes/validator-node/operator/running-validator-node/running-validator-node"},next:{title:"Using Docker",permalink:"/nodes/validator-node/operator/running-validator-node/run-validator-node-using-docker"}},a={},l=[{value:"Deployment Steps",id:"deployment-steps",level:2},{value:"(Optional) Running as a Service",id:"optional-running-as-a-service",level:3},{value:"Connecting to the Aptos Network",id:"connecting-to-the-aptos-network",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"using-source-code",children:"Using Source Code"}),"\n",(0,i.jsx)(n.p,{children:"This is a step-by-step guide to deploy an Aptos validator and validator fullnode (VFN) using source code. Using this guide, the validator\nand VFN will be deployed on separate machines."}),"\n",(0,i.jsx)(n.admonition,{title:"Prerequisites",type:"caution",children:(0,i.jsxs)(n.p,{children:["Before you begin, make sure to read and understand the ",(0,i.jsx)(n.a,{href:"/nodes/validator-node/operator/node-requirements",children:"Node Requirements"}),". Similarly, make sure you have\ninstalled the ",(0,i.jsx)(n.a,{href:"https://aptos.dev/tools/aptos-cli/install-cli/index",children:"Aptos CLI"}),", as you will need it to setup your nodes."]})}),"\n",(0,i.jsx)(n.h2,{id:"deployment-steps",children:"Deployment Steps"}),"\n",(0,i.jsx)(n.admonition,{title:"Default connection to mainnet",type:"tip",children:(0,i.jsx)(n.p,{children:"If you follow the default setup in this document, then your validator and VFN will be connected to the Aptos mainnet.\nTo connect to a different Aptos network, such as testnet, make sure you select the appropriate source code branch\nwhen you build the binary, and download the correct genesis and waypoint files for the network you want to connect to."})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Follow the steps in ",(0,i.jsx)(n.a,{href:"/guides/building-from-source",children:"Building Aptos From Source"})," to download the ",(0,i.jsx)(n.code,{children:"aptos-core"})," repository and source code."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Checkout the ",(0,i.jsx)(n.code,{children:"mainnet"})," branch using ",(0,i.jsx)(n.code,{children:"git checkout --track origin/mainnet"}),". Note: if you want to deploy a validator\nand VFN on another network, use the appropriate branch name (e.g., ",(0,i.jsx)(n.code,{children:"testnet"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Create a working directory for your Aptos nodes, and pick a username for your nodes, e.g.,"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"export WORKSPACE=mainnet\nexport USERNAME=alice\nmkdir ~/$WORKSPACE\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Generate the key pairs for your nodes in your working directory. You can do this by running\nthe following command with the Aptos CLI:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"aptos genesis generate-keys --output-dir ~/$WORKSPACE/keys\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This will create 4 key files under ",(0,i.jsx)(n.code,{children:"~/$WORKSPACE/keys"})," directory:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"public-keys.yaml"}),": This file contains all public keys for your validator and VFN, as well as your account address."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"private-keys.yaml"}),": This file contains all private keys for your validator and VFN."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"validator-identity.yaml"}),": This file contains the public and private keys for your validator, as well as your account address."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"validator-full-node-identity.yaml"}),": This file contains the public and private keys for your VFN, as well as your account address."]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"Backup your private keys",type:"danger",children:(0,i.jsxs)(n.p,{children:["Your private keys are important for you to establish ownership of your nodes. Never share your ",(0,i.jsx)(n.strong,{children:"private"})," keys with anyone,\nand make sure to ",(0,i.jsx)(n.strong,{children:"backup"})," ",(0,i.jsx)(n.code,{children:"private-keys.yaml"})," somewhere safe."]})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Next, you will need to set your validator configuration. This includes setting the validator and VFN host names,\nwhich may be IP addresses or DNS addresses."}),"\n",(0,i.jsx)(n.admonition,{title:"DNS addresses",type:"tip",children:(0,i.jsx)(n.p,{children:"Using DNS is recommended over IP addresses, as it enables more efficient node migrations and is more resilient\nto host changes."})}),"\n",(0,i.jsx)(n.p,{children:"You can set your validator configuration by running the following command with the Aptos CLI:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\n# Replace <validator node IP / DNS address> and <Full Node IP / DNS address> below,\n# with the appropriate IP or DNS address for your nodes.\n\ncd ~/$WORKSPACE\naptos genesis set-validator-configuration \\\n    --local-repository-dir ~/$WORKSPACE \\\n    --username $USERNAME \\\n    --owner-public-identity-file ~/$WORKSPACE/keys/public-keys.yaml \\\n    --validator-host <validator node IP / DNS address>:<Port> \\\n    --full-node-host <Full Node IP / DNS address>:<Port> \\\n    --stake-amount 100000000000000\n\n# For example, if you are using IP addresses:\n\naptos genesis set-validator-configuration \\\n    --local-repository-dir ~/$WORKSPACE \\\n    --username $USERNAME \\\n    --owner-public-identity-file ~/$WORKSPACE/keys/public-keys.yaml \\\n    --validator-host 35.232.235.205:6180 \\\n    --full-node-host 34.135.169.144:6182 \\\n    --stake-amount 100000000000000\n\n# Otherwise, if you are using DNS addresses:\n\naptos genesis set-validator-configuration \\\n    --local-repository-dir ~/$WORKSPACE \\\n    --username $USERNAME \\\n    --owner-public-identity-file ~/$WORKSPACE/keys/public-keys.yaml \\\n    --validator-host bot.aptosdev.com:6180 \\\n    --full-node-host fn.bot.aptosdev.com:6182 \\\n    --stake-amount 100000000000000\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Configuring the validator will create two YAML files in the ",(0,i.jsx)(n.code,{children:"~/$WORKSPACE/$USERNAME"})," directory: ",(0,i.jsx)(n.code,{children:"owner.yaml"})," and\n",(0,i.jsx)(n.code,{children:"operator.yaml"}),". These will be useful for connecting your nodes to the Aptos network (later)."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Download the following files by following the instructions on the ",(0,i.jsx)(n.a,{href:"/nodes/node-files-all-networks/node-files-index",children:"Node Files"})," pages.\nYou will need to select the appropriate network (e.g., ",(0,i.jsx)(n.code,{children:"mainnet"}),", ",(0,i.jsx)(n.code,{children:"testnet"}),", ",(0,i.jsx)(n.code,{children:"devnet"}),") and download the following files:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"validator.yaml"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"fullnode.yaml"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"genesis.blob"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"waypoint.txt"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Next, copy the ",(0,i.jsx)(n.code,{children:"validator.yaml"})," and ",(0,i.jsx)(n.code,{children:"fullnode.yaml"})," template files (that were just downloaded) into the\n",(0,i.jsx)(n.code,{children:"~/$WORKSPACE/config/"})," directory. This can be done by running the following commands:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"mkdir ~/$WORKSPACE/config\ncp validator.yaml ~/$WORKSPACE/config/validator.yaml\ncp fullnode.yaml ~/$WORKSPACE/config/fullnode.yaml\n"})}),"\n",(0,i.jsx)(n.p,{children:"These will be the primary configuration files for your validator and VFN, respectively."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Now, modify the ",(0,i.jsx)(n.code,{children:"validator.yaml"})," and ",(0,i.jsx)(n.code,{children:"fullnode.yaml"})," template files to contain the appropriate information\nand working directories for your validator and VFN."]}),"\n",(0,i.jsxs)(n.p,{children:["For the ",(0,i.jsx)(n.code,{children:"validator.yaml"})," file, you will need to modify the following fields:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"base.data_dir"}),": The directory where the blockchain data will be stored."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"base.waypoint"}),": The waypoint for the genesis transaction on the network you are connecting to."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"consensus.initial_safety_rules_config"}),": The waypoint for the genesis transaction on the network you are connecting to,\nas well as the ",(0,i.jsx)(n.code,{children:"validator-identity.yaml"})," file location."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"execution.genesis_file_location"}),": The genesis blob for the network you are connecting to."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"validator_network.identity"}),": The ",(0,i.jsx)(n.code,{children:"validator-identity.yaml"})," file location."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["For the ",(0,i.jsx)(n.code,{children:"fullnode.yaml"})," file, you will need to modify the following fields:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"base.data_dir"}),": The directory where the blockchain data will be stored."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"base.waypoint"}),": The waypoint for the genesis transaction on the network you are connecting to."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"execution.genesis_file_location"}),": The genesis blob for the network you are connecting to."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"full_node_networks"}),": - The ",(0,i.jsx)(n.code,{children:"public"})," network will need to be updated with the ",(0,i.jsx)(n.code,{children:"validator-full-node-identity.yaml"}),"\nfile location. - The ",(0,i.jsx)(n.code,{children:"vfn"})," network will need to be updated with the correct IP address or DNS address of the validator.\nFor example, if you are using IP addresses, you will need to update the ",(0,i.jsx)(n.code,{children:"addresses"})," field as follows:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'---\naddresses:\n  - "/ip4/100.100.100.100/tcp/6181/noise-ik/..." # Set the IP Address of the validator\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Otherwise, if you are using DNS addresses, you will need to update the ",(0,i.jsx)(n.code,{children:"addresses"})," field as follows:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'---\naddresses:\n  - "/dns/example.com/tcp/6181/noise-ik/..." # Set the DNS Address of the validator\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["To recap, in your working directory (",(0,i.jsx)(n.code,{children:"~/$WORKSPACE"}),"), you should have a list of files:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"config"})," folder containing:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"validator.yaml"}),": The validator config file."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"fullnode.yaml"}),": The VFN config file."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"keys"})," folder containing:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"public-keys.yaml"}),": Public keys for both nodes."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"private-keys.yaml"}),": Private keys for both nodes."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"validator-identity.yaml"}),": Key and account information for the validator."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"validator-full-node-identity.yaml"}),": Key and account information for the VFN."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"$username"})," folder containing:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"owner.yaml"}),": The owner, operator and voter mappings."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"operator.yaml"}),": Validator and VFN operator information."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"waypoint.txt"}),": The waypoint for the genesis transaction on the network you are connecting to."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"genesis.blob"})," The genesis blob for the network you are connecting to."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Now that you have set up your configuration files, you can start your validator and VFN.\nTo start your validator, run the following commands, with the paths assuming you are in the root of the ",(0,i.jsx)(n.code,{children:"aptos-core"})," directory:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cargo clean\ncargo build -p aptos-node --release\nsudo mv target/release/aptos-node /usr/local/bin\naptos-node -f ~/$WORKSPACE/config/validator.yaml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To start your VFN, run the following commands on a separate, dedicated VFN machine. You will need to download the\n",(0,i.jsx)(n.code,{children:"aptos-core"})," source code and build the binary on the VFN machine. Likewise, you will need to copy across\nthe keys and configuration files from the validator machine."]}),"\n",(0,i.jsx)(n.admonition,{title:"VFN identity",type:"danger",children:(0,i.jsx)(n.p,{children:"You should copy the keys and configuration\nfiles across to the VFN machine from the working location where they were generated. Do not attempt to generate\nanother set of keys or files for the VFN, as these will not be recognized by the network."})}),"\n",(0,i.jsxs)(n.p,{children:["Start your VFN by running the following commands, with the paths assuming you are in the root of the ",(0,i.jsx)(n.code,{children:"aptos-core"})," directory:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cargo clean\ncargo build -p aptos-node --release\nsudo mv target/release/aptos-node /usr/local/bin\naptos-node -f ~/$WORKSPACE/config/fullnode.yaml\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Next steps",type:"caution",children:(0,i.jsx)(n.p,{children:"You have now completed setting up your validator and VFN using source code. However, your nodes will not be able to connect\nto the Aptos network just yet."})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"optional-running-as-a-service",children:"(Optional) Running as a Service"}),"\n",(0,i.jsxs)(n.p,{children:["If you want to run ",(0,i.jsx)(n.code,{children:"aptos-node"})," as a service, you can set it up to run as a service controlled by ",(0,i.jsx)(n.code,{children:"systemctl"}),".\nThis is optional, and can be done using the service template below. You will need to modify the template\nto match your environment and configuration."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'[Unit]\nDescription=Aptos Node Service\n\n[Service]\nUser=nodeuser\nGroup=nodeuser\n\nLimitNOFILE=500000\n\n#Environment="RUST_LOG=error"\nWorkingDirectory=/home/nodeuser/aptos-core\nExecStart=/usr/local/bin/aptos-node -f /home/nodeuser/aptos-mainnet/config/validator.yaml\n\nRestart=on-failure\nRestartSec=3s\n\nStandardOutput=journal\nStandardError=journal\nSyslogIdentifier=aptos-node\n\n[Install]\nWantedBy=multi-user.target\n'})}),"\n",(0,i.jsx)(n.h2,{id:"connecting-to-the-aptos-network",children:"Connecting to the Aptos Network"}),"\n",(0,i.jsxs)(n.p,{children:["You have now completed setting up your validator and VFN using source code. Proceed to ",(0,i.jsx)(n.a,{href:"/nodes/validator-node/operator/connect-nodes/connect-validator-node",children:"Connect Nodes"}),"\nfor the next steps."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},83581:(e,n,o)=>{o.d(n,{R:()=>r,x:()=>d});var i=o(11855);const s={},t=i.createContext(s);function r(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);