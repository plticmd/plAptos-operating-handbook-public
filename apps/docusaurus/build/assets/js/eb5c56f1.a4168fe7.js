"use strict";(self.webpackChunkaptos_docs=self.webpackChunkaptos_docs||[]).push([[6200],{69333:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var o=t(63159),s=t(83581);const i={title:"Node Health Checker"},r=void 0,a={id:"nodes/measure/node-health-checker",title:"Node Health Checker",description:"The Aptos Node Health Checker (NHC) service can be used to check the health of any Aptos fullnodes (VFNs or PFNs).",source:"@site/i18n/ja/docusaurus-plugin-content-docs/current/nodes/measure/node-health-checker.md",sourceDirName:"nodes/measure",slug:"/nodes/measure/node-health-checker",permalink:"/nodes/measure/node-health-checker",draft:!1,unlisted:!1,editUrl:"https://github.com/aptos-labs/developer-docs/edit/main/apps/docusaurus/docs/nodes/measure/node-health-checker.md",tags:[],version:"current",lastUpdatedAt:1713276994,formattedLastUpdatedAt:"2024\u5e744\u670816\u65e5",frontMatter:{title:"Node Health Checker"},sidebar:"nodeSidebar",previous:{title:"Important Node Metrics",permalink:"/nodes/measure/important-metrics"}},c={},l=[{value:"Quickstart",id:"quickstart",level:2},{value:"Step 1: Download the baseline configuration YAML",id:"step-1-download-the-baseline-configuration-yaml",level:3},{value:"Step 2: Start the NHC service",id:"step-2-start-the-nhc-service",level:3},{value:"Step 3: Send a request to NHC service",id:"step-3-send-a-request-to-nhc-service",level:3},{value:"How NHC works",id:"how-nhc-works",level:2},{value:"Baseline configuration",id:"baseline-configuration",level:3},{value:"Getting baseline configurations ready",id:"getting-baseline-configurations-ready",level:3},{value:"Configure a pre-existing YAML",id:"configure-a-pre-existing-yaml",level:4},{value:"Required files",id:"required-files",level:3},{value:"Running NHC: Docker",id:"running-nhc-docker",level:2},{value:"Running NHC: Source",id:"running-nhc-source",level:2},{value:"Generating the OpenAPI specs",id:"generating-the-openapi-specs",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"The Aptos Node Health Checker (NHC) service can be used to check the health of any Aptos fullnodes (VFNs or PFNs).\nIf you are a node operator, use the NHC service to check if your node is running correctly. The NHC service evaluates\nyour node's health by comparing against a baseline node configuration, and outputs the evaluation results."}),"\n",(0,o.jsx)(n.p,{children:"This document describes how to run NHC locally when you are operating a node."}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["If you don't want to run the NHC service yourself, you can use the\n",(0,o.jsx)(n.a,{href:"https://nodetools.aptosfoundation.org/#/node_checker",children:"publicly available NHC service"})," run by the Aptos Foundation."]})}),"\n",(0,o.jsx)(n.h2,{id:"quickstart",children:"Quickstart"}),"\n",(0,o.jsx)(n.p,{children:"Before you get into the details of how NHC works, you can run the below steps to start the NHC service and send it a request. This tutorial uses a baseline configuration for a devnet fullnode, i.e., it will evaluate your node against a devnet fullnode that is configured with the baseline configuration YAML."}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Important"}),": If your local node is not a devnet fullnode, you must use a different baseline config. See ",(0,o.jsx)(n.a,{href:"https://github.com/aptos-labs/aptos-core/tree/main/ecosystem/node-checker/configuration_examples",children:"the configuration examples in aptos-core"})," for other such example configs."]}),"\n",(0,o.jsx)(n.h3,{id:"step-1-download-the-baseline-configuration-yaml",children:"Step 1: Download the baseline configuration YAML"}),"\n",(0,o.jsxs)(n.p,{children:["Download a baseline configuration YAML file for a devnet fullnode. The below command will download the ",(0,o.jsx)(n.code,{children:"devnet_fullnode.yaml"})," configuration file:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"mkdir /tmp/nhc\ncd /tmp/nhc\nwget https://raw.githubusercontent.com/aptos-labs/aptos-core/main/ecosystem/node-checker/configuration_examples/devnet_fullnode.yaml\n"})}),"\n",(0,o.jsx)(n.h3,{id:"step-2-start-the-nhc-service",children:"Step 2: Start the NHC service"}),"\n",(0,o.jsxs)(n.p,{children:["Start the NHC service by providing the above-downloaded ",(0,o.jsx)(n.code,{children:"devnet_fullnode.yaml"})," baseline configuration YAML file:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"docker run -v /tmp/nhc:/nhc -p 20121:20121 -t aptoslabs/node-checker:nightly /usr/local/bin/aptos-node-checker server run --baseline-config-paths /nhc/devnet_fullnode.yaml\n"})}),"\n",(0,o.jsx)(n.h3,{id:"step-3-send-a-request-to-nhc-service",children:"Step 3: Send a request to NHC service"}),"\n",(0,o.jsxs)(n.p,{children:["Finally, send a request to the NHC service you started above. The following command runs health checks of your node that is at ",(0,o.jsx)(n.code,{children:"node_url=http://mynode.mysite.com"})," and compares these results with the node configured in the baseline configuration ",(0,o.jsx)(n.code,{children:"devnet_fullnode"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"curl 'http://localhost:20121/check?node_url=http://mynode.mysite.com&api_port=80&baseline_configuration_id=devnet_fullnode'\n"})}),"\n",(0,o.jsx)(n.p,{children:"You will see output similar to this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'{\n  "check_results": [\n    {\n      "headline": "Chain ID reported by baseline and target match",\n      "score": 100,\n      "explanation": "The node under investigation reported the same Chain ID 18 as is reported by the baseline node",\n      "checker_name": "node_identity",\n      "links": []\n    },\n    {\n      "headline": "Role Type reported by baseline and target match",\n      "score": 100,\n      "explanation": "The node under investigation reported the same Role Type full_node as is reported by the baseline node",\n      "checker_name": "node_identity",\n      "links": []\n    },\n    {\n      "headline": "Target node produced valid recent transaction",\n      "score": 100,\n      "explanation": "We were able to pull the same transaction (version: 3238616) from both your node and the baseline node. Great! This implies that your node is keeping up with other nodes in the network.",\n      "checker_name": "transaction_availability",\n      "links": []\n    }\n  ],\n  "summary_score": 100,\n  "summary_explanation": "100: Awesome!"\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"how-nhc-works",children:"How NHC works"}),"\n",(0,o.jsx)(n.p,{children:"The NHC runs as a service. When you want to run a health check of your node, you send the HTTP requests to this service."}),"\n",(0,o.jsx)(n.p,{children:"A single NHC instance can be configured to check the health of multiple node configurations, each of different type, for example:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"A public fullnode connected to the Aptos mainnet."}),"\n",(0,o.jsx)(n.li,{children:"A validator node connected to the Aptos testnet."}),"\n",(0,o.jsx)(n.li,{children:"A node running in a single node testnet."}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"baseline-configuration",children:"Baseline configuration"}),"\n",(0,o.jsx)(n.p,{children:"In all the above cases, a baseline node is used to compare your node's health. For example, for a public fullnode connected to the Aptos devnet, the baseline node might be a node run by the Aptos team and this node demonstrates optimal performance and participation characteristics."}),"\n",(0,o.jsxs)(n.p,{children:["You will download the baseline configuration YAML before running the NHC service for your node. The baseline node's configuration YAML describes where to find this baseline node (URL + port), what evaluators (e.g. metrics checks, TPS tests, API validations, etc.) the NHC service should run, what parameters the NHC should use for those evaluators, what name the configuration has, and so on. See these ",(0,o.jsx)(n.a,{href:"https://github.com/aptos-labs/aptos-core/tree/main/ecosystem/node-checker/configuration_examples",children:"example baseline configuration YAML files"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["When you send requests to the NHC service, you must include a baseline configuration. For example, a request to NHC to use ",(0,o.jsx)(n.code,{children:"devnet_fullnode"})," as the baseline configuration will look like this:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"curl 'http://nhc.aptoslabs.com/check?node_url=http://myfullnode.mysite.com&baseline_configuration_id=devnet_fullnode'\n"})}),"\n",(0,o.jsx)(n.h3,{id:"getting-baseline-configurations-ready",children:"Getting baseline configurations ready"}),"\n",(0,o.jsx)(n.p,{children:"In order to run the NHC service, you must have a baseline configuration that the service can use. You have two options here:"}),"\n",(0,o.jsx)(n.h4,{id:"configure-a-pre-existing-yaml",children:"Configure a pre-existing YAML"}),"\n",(0,o.jsxs)(n.p,{children:["You can find a few ",(0,o.jsx)(n.a,{href:"https://github.com/aptos-labs/aptos-core/tree/main/ecosystem/node-checker/configuration_examples",children:"example baseline configuration YAML files"})," that work for each of the above use cases and more."]}),"\n",(0,o.jsxs)(n.p,{children:["Next, download these configuration YAML files into the ",(0,o.jsx)(n.code,{children:"/etc/nhc"})," folder in your host system. For example:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"mkdir /tmp/nhc\ncd /tmp/nhc\nconfigs=(devnet_fullnode testnet_fullnode mainnet_fullnode); for c in ${configs[@]}; do wget https://raw.githubusercontent.com/aptos-labs/aptos-core/main/ecosystem/node-checker/configuration_examples/$c.yaml; done\n"})}),"\n",(0,o.jsxs)(n.p,{children:["These configurations are not quite ready to be used as they are. You will need to modify certain fields, such as the baseline node address or evaluator set (",(0,o.jsx)(n.code,{children:"evaluators"})," and ",(0,o.jsx)(n.code,{children:"evaluator_args"})," in the YAML) used. The best way to iterate on this is to run the NHC with a downloaded baseline configuration and see what it says on startup."]}),"\n",(0,o.jsx)(n.h3,{id:"required-files",children:"Required files"}),"\n",(0,o.jsxs)(n.p,{children:["For some NHC configurations, you will need accompanying files, e.g. ",(0,o.jsx)(n.code,{children:"mint.key"})," to use for running a TPS test against a validator. You should make sure these files are also available to NHC, either on disk or mounted into your container. NHC expects them on startup at a path specified in the baseline configuration YAML."]}),"\n",(0,o.jsx)(n.h2,{id:"running-nhc-docker",children:"Running NHC: Docker"}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsx)(n.p,{children:"While the Aptos team hosts our own instances of this service, we encourage node operators to run their own instances."})}),"\n",(0,o.jsx)(n.p,{children:"When you are ready with baseline configuration YAML and the required files, you can run the NHC server with a command like this, for example, with Docker:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"docker run -v /etc/nhc:/etc/nhc -p 20121:20121 -t aptoslabs/node-checker:nightly /usr/local/bin/aptos-node-checker server run --baseline-config-paths /tmp/nhc/devnet_fullnode.yaml /tmp/nhc/testnet_fullnode.yaml /tmp/nhc/mainnet/fullnode.yaml\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["You may want to include other environment variables such as ",(0,o.jsx)(n.code,{children:"RUST_LOG=info"}),". As you can see, by default NHC runs on port 20121. Make sure to publish it from the container, as shown in the above command, and ensure the port is open on your host. You may change the port NHC runs on with ",(0,o.jsx)(n.code,{children:"--listen-port"}),"."]})}),"\n",(0,o.jsx)(n.h2,{id:"running-nhc-source",children:"Running NHC: Source"}),"\n",(0,o.jsx)(n.p,{children:"First, check out the source:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"git clone git@github.com:aptos-labs/aptos-core.git\ncd aptos-core\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Depending on your setup, you may want to check out a particular branch, to ensure NHC is compatible with your node, e.g. ",(0,o.jsx)(n.code,{children:"git checkout --track devnet"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Run NHC:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"cargo run -p aptos-node-checker --release -- server run --baseline-config-paths /tmp/nhc/devnet_fullnode.yaml\n"})}),"\n",(0,o.jsx)(n.h2,{id:"generating-the-openapi-specs",children:"Generating the OpenAPI specs"}),"\n",(0,o.jsxs)(n.p,{children:["To generate the OpenAPI specs, run the following commands from ",(0,o.jsx)(n.code,{children:"ecosystem/node-checker"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"cargo run -- server generate-openapi -f yaml > doc/spec.yaml\ncargo run -- server generate-openapi -f json > doc/spec.json\n"})}),"\n",(0,o.jsxs)(n.p,{children:["You can also hit the ",(0,o.jsx)(n.code,{children:"/spec.yaml"})," and ",(0,o.jsx)(n.code,{children:"/spec.json"})," endpoints of the running service."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},83581:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var o=t(11855);const s={},i=o.createContext(s);function r(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);